import{connect}from"cloudflare:sockets";let userID="";let proxyIP="";let sub="";let subConverter="SUBAPI.fxxk.dedyn.io";let subConfig="https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Mini_MultiMode.ini";let subProtocol="https";let subEmoji="true";let socks5Address="";let parsedSocks5Address={};let enableSocks=false;let fakeUserID;let fakeHostName;let noTLS="false";const expire=4102329600;let proxyIPs;let socks5s;let go2Socks5s=["*ttvnw.net","*tapecontent.net","*cloudatacdn.com","*.loadshare.org",];let addresses=[];let addressesapi=[];let addressesnotls=[];let addressesnotlsapi=[];let addressescsv=[];let DLS=8;let remarkIndex=1;let FileName=atob("ZWRnZXR1bm5lbA==");let BotToken;let ChatID;let proxyhosts=[];let proxyhostsURL="";let RproxyIP="false";let httpsPorts=["2053","2083","2087","2096","8443"];let time01=7;let time02=3;let userIDLow;let userIDTime="";let proxyIPPool=[];let path="/?ed=2560";let tiaoid;let link=[];let banHosts=[atob("c3BlZWQuY2xvdWRmbGFyZS5jb20=")];export default{async fetch(request,env,ctx){try{const UA=request.headers.get("User-Agent")||"null";const userAgent=UA.toLowerCase();userID=env.UUID||env.uuid||env.PASSWORD||env.pswd||userID;if(env.KEY||env.TOKEN||(userID&&!isValidUUID(userID))){tiaoid=env.KEY||env.TOKEN||userID;time01=Number(env.TIME)||time01;time02=Number(env.UPTIME)||time02;const userIDs=await cetiaoid(tiaoid);userID=userIDs[0];userIDLow=userIDs[1]}if(!userID){return new Response("请设置你的UUID变量，或尝试重试部署，检查变量是否生效？",{status:404,headers:{"Content-Type":"text/plain;charset=utf-8",},})}const currentDate=new Date();currentDate.setHours(0,0,0,0);const timestamp=Math.ceil(currentDate.getTime()/1000);const fakeUserIDMD5=await shuangsha(`${userID}${timestamp}`);fakeUserID=[fakeUserIDMD5.slice(0,8),fakeUserIDMD5.slice(8,12),fakeUserIDMD5.slice(12,16),fakeUserIDMD5.slice(16,20),fakeUserIDMD5.slice(20),].join("-");fakeHostName=`${fakeUserIDMD5.slice(6,9)}.${fakeUserIDMD5.slice(13,19)}`;proxyIP=env.PROXYIP||env.proxyip||proxyIP;proxyIPs=await shoushi(proxyIP);proxyIP=proxyIPs[Math.floor(Math.random()*proxyIPs.length)];socks5Address=env.SOCKS5||socks5Address;socks5s=await shoushi(socks5Address);socks5Address=socks5s[Math.floor(Math.random()*socks5s.length)];socks5Address=socks5Address.split("//")[1]||socks5Address;if(env.GO2SOCKS5)go2Socks5s=await shoushi(env.GO2SOCKS5);if(env.CFPORTS)httpsPorts=await shoushi(env.CFPORTS);if(env.BAN)banHosts=await shoushi(env.BAN);if(socks5Address){try{parsedSocks5Address=socks5AddressParser(socks5Address);RproxyIP=env.RPROXYIP||"false";enableSocks=true}catch(err){console.log(err.toString());RproxyIP=env.RPROXYIP||!proxyIP?"true":"false";enableSocks=false}}else{RproxyIP=env.RPROXYIP||!proxyIP?"true":"false"}const upgradeHeader=request.headers.get("Upgrade");const url=new URL(request.url);if(!upgradeHeader||upgradeHeader!=="websocket"){if(env.ADD)addresses=await shoushi(env.ADD);if(env.ADDAPI)addressesapi=await shoushi(env.ADDAPI);if(env.ADDNOTLS)addressesnotls=await shoushi(env.ADDNOTLS);if(env.ADDNOTLSAPI)addressesnotlsapi=await shoushi(env.ADDNOTLSAPI);if(env.ADDCSV)addressescsv=await shoushi(env.ADDCSV);DLS=Number(env.DLS)||DLS;remarkIndex=Number(env.CSVREMARK)||remarkIndex;BotToken=env.TGTOKEN||BotToken;ChatID=env.TGID||ChatID;FileName=env.SUBNAME||FileName;subEmoji=env.SUBEMOJI||env.EMOJI||subEmoji;if(subEmoji==="0")subEmoji="false";if(env.LINK)link=await shoushi(env.LINK);sub=env.SUB||sub;subConverter=env.SUBAPI||subConverter;if(subConverter.includes("https://")){subConverter=subConverter.split("//")[1];subProtocol="http"}else{subConverter=subConverter.split("//")[1]||subConverter}subConfig=env.SUBCONFIG||subConfig;if(url.searchParams.has("sub")&&url.searchParams.get("sub")!=="")sub=url.searchParams.get("sub");if(url.searchParams.has("notls"))noTLS="true";if(url.searchParams.has("proxyip")){path=`/?ed=2560&proxyip=${url.searchParams.get("proxyip")}`;RproxyIP="false"}else if(url.searchParams.has("socks5")){path=`/?ed=2560&socks5=${url.searchParams.get("socks5")}`;RproxyIP="false"}else if(url.searchParams.has("socks")){path=`/?ed=2560&socks5=${url.searchParams.get("socks")}`;RproxyIP="false"}const ul=url.pathname.toLowerCase();if(ul==="/"){if(env.URL302)return Response.redirect(env.URL302,302);else if(env.URL)return await dul(env.URL,url);else return new Response(JSON.stringify(request.cf,null,4),{status:200,headers:{"content-type":"application/json",},})}else if(ul===`/${fakeUserID}`){const fakeConfig=await cepz(userID,request.headers.get("Host"),sub,"CF-Workers-SUB",RproxyIP,url,env);return new Response(`${fakeConfig}`,{status:200})}else if(url.pathname===`/${tiaoid}/edit`||ul===`/${userID}/edit`){return await KV(request,env);}else if(url.pathname===`/${tiaoid}`||ul===`/${userID}`){await sendMessage(`#获取订阅${FileName}`,request.headers.get("CF-Connecting-IP"),`UA:${UA}</tg-spoiler>\n域名:${url.hostname}\n<tg-spoiler>入口:${url.pathname+url.search}</tg-spoiler>`);const whisinfo=await cepz(userID,request.headers.get("Host"),sub,UA,RproxyIP,url,env);const now=Date.now();const today=new Date(now);today.setHours(0,0,0,0);const UD=Math.floor((((now-today.getTime())/86400000)*24*1099511627776)/2);let pagesSum=UD;let workersSum=UD;let total=24*1099511627776;if(userAgent&&userAgent.includes("mozilla")){return new Response(`<div style="font-size:13px;">${whisinfo}</div>`,{status:200,headers:{"Content-Type":"text/html;charset=utf-8","Profile-Update-Interval":"6","Subscription-Userinfo":`upload=${pagesSum};download=${workersSum};total=${total};expire=${expire}`,"Cache-Control":"no-store",},})}else{return new Response(`${whisinfo}`,{status:200,headers:{"Content-Disposition":`attachment;filename=${FileName};filename*=utf-8''${encodeURIComponent(FileName)}`,"Content-Type":"text/plain;charset=utf-8","Profile-Update-Interval":"6","Subscription-Userinfo":`upload=${pagesSum};download=${workersSum};total=${total};expire=${expire}`,},})}}else{if(env.URL302)return Response.redirect(env.URL302,302);else if(env.URL)return await dul(env.URL,url);else return new Response("不用怀疑！你UUID就是错的！！！",{status:404,})}}else{socks5Address=url.searchParams.get("socks5")||socks5Address;if(new RegExp("/socks5=","i").test(url.pathname))socks5Address=url.pathname.split("5=")[1];else if(new RegExp("/socks://","i").test(url.pathname)||new RegExp("/socks5://","i").test(url.pathname)){socks5Address=url.pathname.split("://")[1].split("#")[0];if(socks5Address.includes("@")){let userPassword=socks5Address.split("@")[0];const base64Regex=/^(?:[A-Z0-9+/]{4})*(?:[A-Z0-9+/]{2}==|[A-Z0-9+/]{3}=)?$/i;if(base64Regex.test(userPassword)&&!userPassword.includes(":"))userPassword=atob(userPassword);socks5Address=`${userPassword}@${socks5Address.split("@")[1]}`}}if(socks5Address){try{parsedSocks5Address=socks5AddressParser(socks5Address);enableSocks=true}catch(err){console.log(err.toString());enableSocks=false}}else{enableSocks=false}if(url.searchParams.has("proxyip")){proxyIP=url.searchParams.get("proxyip");enableSocks=false}else if(new RegExp("/proxyip=","i").test(url.pathname)){proxyIP=url.pathname.toLowerCase().split("/proxyip=")[1];enableSocks=false}else if(new RegExp("/proxyip.","i").test(url.pathname)){proxyIP=`proxyip.${url.pathname.toLowerCase().split("/proxyip.")[1]}`;enableSocks=false}else if(new RegExp("/pyip=","i").test(url.pathname)){proxyIP=url.pathname.toLowerCase().split("/pyip=")[1];enableSocks=false}return await whisOWSH(request)}}catch(err){return new Response(err.toString())}},};async function whisOWSH(a){const webSocketPair=new WebSocketPair();const[client,webSocket]=Object.values(webSocketPair);webSocket.accept();let address="";let portWithRandomLog="";const log=(info,event)=>{console.log(`[${address}:${portWithRandomLog}]${info}`,event||"")};const earlyDataHeader=a.headers.get("sec-websocket-protocol")||"";const readableWebSocketStream=makeReadableWebSocketStream(webSocket,earlyDataHeader,log);let remoteSocketWapper={value:null,};let isDns=false;readableWebSocketStream.pipeTo(new WritableStream({async write(chunk,controller){if(isDns){return await handleDNSQuery(chunk,webSocket,null,log)}if(remoteSocketWapper.value){const writer=remoteSocketWapper.value.writable.getWriter();await writer.write(chunk);writer.releaseLock();return}const{hasError,message,addressType,portRemote=443,addressRemote="",rawDataIndex,whisV=new Uint8Array([0,0]),isUDP,}=pwhisH(chunk,userID);address=addressRemote;portWithRandomLog=`${portRemote}--${Math.random()}${isUDP?"udp ":"tcp "}`;if(hasError){throw new Error(message);}if(isUDP){if(portRemote===53){isDns=true}else{throw new Error("UDP 代理仅对 DNS（53 端口）启用");}}const whisRH=new Uint8Array([whisV[0],0]);const rawClientData=chunk.slice(rawDataIndex);if(isDns){return handleDNSQuery(rawClientData,webSocket,whisRH,log)}if(!banHosts.includes(addressRemote)){log(`处理TCP出站连接${addressRemote}:${portRemote}`);handleTCPOutBound(remoteSocketWapper,addressType,addressRemote,portRemote,rawClientData,webSocket,whisRH,log)}else{throw new Error(`黑名单关闭TCP出站连接${addressRemote}:${portRemote}`)}},close(){log(`readableWebSocketStream已关闭`)},abort(reason){log(`readableWebSocketStream已中止`,JSON.stringify(reason))},})).catch((err)=>{log("readableWebSocketStream 管道错误",err)});return new Response(null,{status:101,webSocket:client,})}async function handleTCPOutBound(d,e,f,g,h,i,j,k){async function useSocks5Pattern(a){if(go2Socks5s.includes(atob("YWxsIGlu"))||go2Socks5s.includes(atob("Kg==")))return true;return go2Socks5s.some((pattern)=>{let regexPattern=pattern.replace(/\*/g,".*");let regex=new RegExp(`^${regexPattern}$`,"i");return regex.test(a)})}async function connectAndWrite(a,b,c){k(`connected to ${a}:${b}`);const tcpSocket=socks?await socks5Connect(e,a,b,k):connect({hostname:a,port:b,});d.value=tcpSocket;const writer=tcpSocket.writable.getWriter();await writer.write(h);writer.releaseLock();return tcpSocket}async function retry(){if(enableSocks){tcpSocket=await connectAndWrite(f,g,true)}else{if(!proxyIP||proxyIP===""){proxyIP=atob(`UFJPWFlJUC50cDEuZnh4ay5kZWR5bi5pbw==`)}else if(proxyIP.includes("]:")){g=proxyIP.split("]:")[1]||g;proxyIP=proxyIP.split("]:")[0]||proxyIP}else if(proxyIP.split(":").length===2){g=proxyIP.split(":")[1]||g;proxyIP=proxyIP.split(":")[0]||proxyIP}if(proxyIP.includes(".tp"))g=proxyIP.split(".tp")[1].split(".")[0]||g;tcpSocket=await connectAndWrite(proxyIP||f,g)}tcpSocket.closed.catch((error)=>{console.log("retry tcpSocket closed error",error)}).finally(()=>{safeCloseWebSocket(i)});remoteSocketToWS(tcpSocket,i,j,null,k)}let useSocks=false;if(go2Socks5s.length>0&&enableSocks)useSocks=await useSocks5Pattern(f);let tcpSocket=await connectAndWrite(f,g,useSocks);remoteSocketToWS(tcpSocket,i,j,retry,k)}function makeReadableWebSocketStream(a,b,c){let readableStreamCancel=false;return new ReadableStream({start(controller){a.addEventListener("message",(event)=>{if(readableStreamCancel){return}const message=event.data;controller.enqueue(message)});a.addEventListener("close",()=>{safeCloseWebSocket(a);if(readableStreamCancel){return}controller.close()});a.addEventListener("error",(err)=>{c("WebSocket 服务器发生错误");controller.error(err)});const{earlyData,error}=base64ToArrayBuffer(b);if(error){controller.error(error)}else if(earlyData){controller.enqueue(earlyData)}},pull(controller){},cancel(reason){if(readableStreamCancel){return}c(`可读流被取消，原因是${reason}`);readableStreamCancel=true;safeCloseWebSocket(a)},})}function pwhisH(d,e){if(d.byteLength<24){return{hasError:true,message:"invalid data",}}const version=new Uint8Array(d.slice(0,1));let isValidUser;let isUDP=false;function isUserIDValid(a,b,c){const userIDArray=new Uint8Array(c.slice(1,17));const userIDString=stringify(userIDArray);return userIDString===a||userIDString===b}isValidUser=isUserIDValid(e,userIDLow,d);if(!isValidUser){return{hasError:true,message:`invalid user ${new Uint8Array(d.slice(1,17))}`,}}const optLength=new Uint8Array(d.slice(17,18))[0];const command=new Uint8Array(d.slice(18+optLength,18+optLength+1))[0];if(command===1){}else if(command===2){isUDP=true}else{return{hasError:true,message:`command ${command}is not support,command 01-tcp,02-udp,03-mux`,}}const portIndex=18+optLength+1;const portBuffer=d.slice(portIndex,portIndex+2);const portRemote=new DataView(portBuffer).getUint16(0);let addressIndex=portIndex+2;const addressBuffer=new Uint8Array(d.slice(addressIndex,addressIndex+1));const addressType=addressBuffer[0];let addressLength=0;let addressValueIndex=addressIndex+1;let addressValue="";switch(addressType){case 1:addressLength=4;addressValue=new Uint8Array(d.slice(addressValueIndex,addressValueIndex+addressLength)).join(".");break;case 2:addressLength=new Uint8Array(d.slice(addressValueIndex,addressValueIndex+1))[0];addressValueIndex+=1;addressValue=new TextDecoder().decode(d.slice(addressValueIndex,addressValueIndex+addressLength));break;case 3:addressLength=16;const dataView=new DataView(d.slice(addressValueIndex,addressValueIndex+addressLength));const ipv6=[];for(let i=0;i<8;i++){ipv6.push(dataView.getUint16(i*2).toString(16))}addressValue=ipv6.join(":");break;default:return{hasError:true,message:`invild addressType is ${addressType}`,}}if(!addressValue){return{hasError:true,message:`addressValue is empty,addressType is ${addressType}`,}}return{hasError:false,addressRemote:addressValue,addressType,portRemote,rawDataIndex:addressValueIndex+addressLength,whisV:version,isUDP,}}async function remoteSocketToWS(a,b,c,d,e){let remoteChunkCount=0;let chunks=[];let whisH=c;let hasIncomingData=false;await a.readable.pipeTo(new WritableStream({start(){},async write(chunk,controller){hasIncomingData=true;if(b.readyState!==WS_READY_STATE_OPEN){controller.error("webSocket.readyState is not open, maybe close")}if(whisH){b.send(await new Blob([whisH,chunk]).arrayBuffer());whisH=null}else{b.send(chunk)}},close(){e(`remoteConnection!.readable is close with hasIncomingData is ${hasIncomingData}`)},abort(reason){console.error(`remoteConnection!.readable abort`,reason)},})).catch((error)=>{console.error(`remoteSocketToWS has exception`,error.stack||error);safeCloseWebSocket(b)});if(hasIncomingData===false&&d){e(`d`);d()}}function base64ToArrayBuffer(a){if(!a){return{earlyData:undefined,error:null}}try{a=a.replace(/-/g,"+").replace(/_/g,"/");const decode=atob(a);const arryBuffer=Uint8Array.from(decode,(c)=>c.charCodeAt(0));return{earlyData:arryBuffer.buffer,error:null}}catch(error){return{earlyData:undefined,error}}}function isValidUUID(a){const uuidRegex=/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;return uuidRegex.test(a)}const WS_READY_STATE_OPEN=1;const WS_READY_STATE_CLOSING=2;function safeCloseWebSocket(a){try{if(a.readyState===WS_READY_STATE_OPEN||a.readyState===WS_READY_STATE_CLOSING){a.close()}}catch(error){console.error("safeCloseWebSocket error",error)}}const byteToHex=[];for(let i=0;i<256;++i){byteToHex.push((i+256).toString(16).slice(1))}function unsafeStringify(a,b){return(byteToHex[a[offset]]+byteToHex[a[offset+1]]+byteToHex[a[offset+2]]+byteToHex[a[offset+3]]+"-"+byteToHex[a[offset+4]]+byteToHex[a[offset+5]]+"-"+byteToHex[a[offset+6]]+byteToHex[a[offset+7]]+"-"+byteToHex[a[offset+8]]+byteToHex[a[offset+9]]+"-"+byteToHex[a[offset+10]]+byteToHex[a[offset+11]]+byteToHex[a[offset+12]]+byteToHex[a[offset+13]]+byteToHex[a[offset+14]]+byteToHex[a[offset+15]]).toLowerCase()}function stringify(a,b){const uuid=unsafeStringify(a,offset);if(!isValidUUID(uuid)){throw TypeError(`生成的UUID不符合规范${uuid}`)}return uuid}async function handleDNSQuery(a,b,c,d){try{const dnsServer="8.8.4.4";const dnsPort=53;let whisH=c;const tcpSocket=connect({hostname:dnsServer,port:dnsPort,});d(`连接到${dnsServer}:${dnsPort}`);const writer=tcpSocket.writable.getWriter();await writer.write(a);writer.releaseLock();await tcpSocket.readable.pipeTo(new WritableStream({async write(chunk){if(b.readyState===WS_READY_STATE_OPEN){if(whisH){b.send(await new Blob([whisH,chunk]).arrayBuffer());whisH=null}else{b.send(chunk)}}},close(){d(`DNS服务器(${dnsServer})TCP连接已关闭`)},abort(reason){console.error(`DNS服务器(${dnsServer})TCP连接异常中断`,reason)},}))}catch(error){console.error(`handleDNSQuery函数发生异常，错误信息:${error.message}`)}}async function socks5Connect(a,b,c,d){const{username,password,hostname,port}=parsedSocks5Address;const socket=connect({hostname,port,});const socksGreeting=new Uint8Array([5,2,0,2]);const writer=socket.writable.getWriter();await writer.write(socksGreeting);d("已发送 SOCKS5 问候消息");const reader=socket.readable.getReader();const encoder=new TextEncoder();let res=(await reader.read()).value;if(res[0]!==0x05){d(`SOCKS5服务器版本错误:收到${res[0]}，期望是5`);return}if(res[1]===0xff){d("服务器不接受任何认证方法");return}if(res[1]===0x02){d("SOCKS5 服务器需要认证");if(!username||!password){d("请提供用户名和密码");return}const authRequest=new Uint8Array([1,username.length,...encoder.encode(username),password.length,...encoder.encode(password),]);await writer.write(authRequest);res=(await reader.read()).value;if(res[0]!==0x01||res[1]!==0x00){d("SOCKS5 服务器认证失败");return}}let DSTADDR;switch(a){case 1:DSTADDR=new Uint8Array([1,...addressRemote.split(".").map(Number)]);break;case 2:DSTADDR=new Uint8Array([3,b.length,...encoder.encode(b),]);break;case 3:DSTADDR=new Uint8Array([4,...addressRemote.split(":").flatMap((x)=>[parseInt(x.slice(0,2),16),parseInt(x.slice(2),16),]),]);break;default:d(`无效的地址类型:${a}`);return}const socksRequest=new Uint8Array([5,1,0,...DSTADDR,c>>8,c&0xff,]);await writer.write(socksRequest);d("已发送 SOCKS5 请求");res=(await reader.read()).value;if(res[1]===0x00){d("SOCKS5 连接已建立")}else{d("SOCKS5 连接建立失败");return}writer.releaseLock();reader.releaseLock();return socket}function socks5AddressParser(a){let[latter,former]=a.split("@").reverse();let username,password,hostname,port;if(former){const formers=former.split(":");if(formers.length!==2){throw new Error('无效的 SOCKS 地址格式：认证部分必须是 "username:password" 的形式');}[username,password]=formers}const latters=latter.split(":");port=Number(latters.pop());if(isNaN(port)){throw new Error("无效的 SOCKS 地址格式：端口号必须是数字");}hostname=latters.join(":");const regex=/^\[.*]$/;if(hostname.includes(":")&&!regex.test(hostname)){throw new Error("无效的 SOCKS 地址格式：IPv6 地址必须用方括号括起来，如 [2001:db8::1]");}return{username,password,hostname,port,}}function hfwzxx(a,b,c,d){if(d)a=atob(a);a=a.replace(new RegExp(fakeUserID,"g"),b).replace(new RegExp(fakeHostName,"g"),c);if(d)a=btoa(a);return a}async function shuangsha(a){const bmq=new TextEncoder();const onesha=await crypto.subtle.digest("MD5",bmq.encode(a));const oneshaarr=Array.from(new Uint8Array(onesha));const onehex=oneshaarr.map((bits)=>bits.toString(16).padStart(2,"0")).join("");const twosha=await crypto.subtle.digest("MD5",bmq.encode(onehex.slice(7,27)));const twoshaarr=Array.from(new Uint8Array(twosha));const twohex=twoshaarr.map((bits)=>bits.toString(16).padStart(2,"0")).join("");return twohex.toLowerCase()}async function dul(a,b){const ulist=await shoushi(a);const wurl=ulist[Math.floor(Math.random()*ulist.length)];let jurl=new URL(wurl);console.log(jurl);let XY=jurl.protocol.slice(0,-1)||"https";let HH=jurl.hostname;let ulname=jurl.pathname;let cxarg=jurl.search;if(ulname.charAt(ulname.length-1)==="/"){ulname=ulname.slice(0,-1)}ulname+=b.pathname;let nurl=`${XY}:let xyy=await fetch(nurl);let xxy=new Response(xyy.body,{status:xyy.status,statusText:xyy.statusText,headers:xyy.headers,});xxy.headers.set("X-New-URL",nurl);return xxy}const what=atob("ZG14bGMzTT0=");function pzinfo(a,b){const xylx=atob(what);const bm=FileName;let dz=b;let dk=443;const UID=a;const jmfs="none";const csXY="ws";const wzym=b;const ul=path;let csaq=["tls",true];const SNI=b;const zw="randomized";if(b.includes(".workers.dev")){dz=atob("dmlzYS5jbg==");dk=80;csaq=["",false]}const WTR=`${xylx}:"p"+`${atob("dGlvbj0=")+jmfs}\u0026\u0073\u0065\u0063\u0075\u0072\u0069\u0074\u0079\u003d${csaq[0]}&sni=${SNI}&fp=${zw}&type=${csXY}&host=${wzym}&path=${encodeURIComponent(ul)}#${encodeURIComponent(bm)}`;const gogogo=`-{name:${FileName},server:${dz},port:${dk},type:${xylx},uuid:${UID},tls:${csaq[1]},alpn:[h3],udp:false,sni:${SNI},tfo:false,skip-cert-verify:true,servername:${wzym},client-fingerprint:${zw},network:${csXY},ws-opts:{path:"${ul}",headers:{${wzym}}}}`;return[WTR,gogogo]}let subParams=["sub","base64","b64","clash","singbox","sb"];const cmad=decodeURIComponent(atob("dGVsZWdyYW0lMjAlRTQlQkElQTQlRTYlQjUlODElRTclQkUlQTQlMjAlRTYlOEElODAlRTYlOUMlQUYlRTUlQTQlQTclRTQlQkQlQUMlN0UlRTUlOUMlQTglRTclQkElQkYlRTUlOEYlOTElRTclODklOEMhJTNDYnIlM0UKJTNDYSUyMGhyZWYlM0QlMjdodHRwcyUzQSUyRiUyRnQubWUlMkZDTUxpdXNzc3MlMjclM0VodHRwcyUzQSUyRiUyRnQubWUlMkZDTUxpdXNzc3MlM0MlMkZhJTNFJTNDYnIlM0UKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tJTNDYnIlM0UKZ2l0aHViJTIwJUU5JUExJUI5JUU3JTlCJUFFJUU1JTlDJUIwJUU1JTlEJTgwJTIwU3RhciFTdGFyIVN0YXIhISElM0NiciUzRQolM0NhJTIwaHJlZiUzRCUyN2h0dHBzJTNBJTJGJTJGZ2l0aHViLmNvbSUyRmNtbGl1JTJGZWRnZXR1bm5lbCUyNyUzRWh0dHBzJTNBJTJGJTJGZ2l0aHViLmNvbSUyRmNtbGl1JTJGZWRnZXR1bm5lbCUzQyUyRmElM0UlM0NiciUzRQotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0lM0NiciUzRQolMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjM="));async function cepz(b,c,d,e,f,g,h){if(d){const match=d.match(/^(?:https?:\/\/)?([^\/]+)/);if(match){d=match[1]}const subs=await shoushi(d);if(subs.length>1)d=subs[0]}else{if(h.KV){await qydzlist(h);const gooddzlist=await h.KV.get("ADD.txt");if(gooddzlist){const gooddzarr=await shoushi(gooddzlist);const fldz={jkdz:new Set(),linkdz:new Set(),gooddz:new Set(),};for(const ys of gooddzarr){if(ys.startsWith("https://")){fldz.jkdz.add(ys)}else if(ys.includes("://")){fldz.linkdz.add(ys)}else{fldz.gooddz.add(ys)}}addressesapi=[...fldz.jkdz];link=[...fldz.linkdz];addresses=[...fldz.gooddz]}}if(addresses.length+addressesapi.length+addressesnotls.length+addressesnotlsapi.length+addressescsv.length===0){let cfips=["103.21.244.0/23","104.16.0.0/13","104.24.0.0/14","172.64.0.0/14","103.21.244.0/23","104.16.0.0/14","104.24.0.0/15","141.101.64.0/19","172.64.0.0/14","188.114.96.0/21","190.93.240.0/21",];function generateRandomIPFromCIDR(a){const[base,mask]=a.split("/");const baseIP=base.split(".").map(Number);const subnetMask=32-parseInt(mask,10);const maxHosts=Math.pow(2,subnetMask)-1;const randomHost=Math.floor(Math.random()*maxHosts);const randomIP=baseIP.map((octet,index)=>{if(index<2)return octet;if(index===2)return((octet&(255<<(subnetMask-8)))+((randomHost>>8)&255));return(octet&(255<<subnetMask))+(randomHost&255)});return randomIP.join(".")}addresses=addresses.concat("127.0.0.1:1234#CFnat");if(c.includes(".workers.dev")){addressesnotls=addressesnotls.concat(cfips.map((cidr)=>generateRandomIPFromCIDR(cidr)+"#CF随机节点"))}else{addresses=addresses.concat(cfips.map((cidr)=>generateRandomIPFromCIDR(cidr)+"#CF随机节点"))}}}const uuid=g.pathname===`/${tiaoid}`?tiaoid:b;const userAgent=e.toLowerCase();const Config=pzinfo(b,c);const v2ray=Config[0];const clash=Config[1];let proxyhost="";if(c.includes(".workers.dev")){if(proxyhostsURL&&(!proxyhosts||proxyhosts.length===0)){try{const response=await fetch(proxyhostsURL);if(!response.ok){console.error("获取地址时出错:",response.status,response.statusText);return}const text=await response.text();const lines=text.split("\n");const nonEmptyLines=lines.filter((line)=>line.trim()!=="");proxyhosts=proxyhosts.concat(nonEmptyLines)}catch(error){}}if(proxyhosts.length!==0)proxyhost=proxyhosts[Math.floor(Math.random()*proxyhosts.length)]+"/"}if(userAgent.includes("mozilla")&&!subParams.some((_searchParams)=>g.searchParams.has(_searchParams))){const newSocks5s=socks5s.map((socks5Address)=>{if(socks5Address.includes("@"))return socks5Address.split("@")[1];else if(socks5Address.includes("//"))return socks5Address.split("//")[1];else return socks5Address});let socks5List="";if(go2Socks5s.length>0&&enableSocks){socks5List=`${decodeURIComponent("SOCKS5%EF%BC%88%E7%99%BD%E5%90%8D%E5%8D%95%EF%BC%89%3A%20")}`;if(go2Socks5s.includes(atob("YWxsIGlu"))||go2Socks5s.includes(atob("Kg==")))socks5List+=`${decodeURIComponent("%E6%89%80%E6%9C%89%E6%B5%81%E9%87%8F")}<br>`;else socks5List+=`<br>&nbsp;&nbsp;${go2Socks5s.join("<br>&nbsp;&nbsp;")}<br>`}let dyq="<br>";if(d){if(enableSocks)dyq+=`CFCDN（访问方式）:Socks5<br>&nbsp;&nbsp;${newSocks5s.join("<br>&nbsp;&nbsp;")}<br>${socks5List}`;else if(proxyIP&&proxyIP!=="")dyq+=`CFCDN（访问方式）:ProxyIP<br>&nbsp;&nbsp;${proxyIPs.join("<br>&nbsp;&nbsp;")}<br>`;else if(f==="true")dyq+=`CFCDN（访问方式）:自动获取ProxyIP<br>`;else dyq+=`CFCDN（访问方式）:无法访问,需要您设置proxyIP/PROXYIP！！！<br>`;dyq+=`<br>SUB（优选订阅生成器）:${d}`}else{if(enableSocks)dyq+=`CFCDN（访问方式）:Socks5<br>&nbsp;&nbsp;${newSocks5s.join("<br>&nbsp;&nbsp;")}<br>${socks5List}`;else if(proxyIP&&proxyIP!=="")dyq+=`CFCDN（访问方式）:ProxyIP<br>&nbsp;&nbsp;${proxyIPs.join("<br>&nbsp;&nbsp;")}<br>`;else dyq+=`CFCDN（访问方式）:无法访问,需要您设置proxyIP/PROXYIP！！！<br>`;let ifKV="";if(h.KV)ifKV=`<a href='${_url.pathname}/edit'>编辑优选列表</a>`;dyq+=`<br>您的订阅内容由内置addresses/ADD*参数变量提供${ifKV}<br>`;if(addresses.length>0)dyq+=`ADD（TLS优选域名&IP）:<br>&nbsp;&nbsp;${addresses.join("<br>&nbsp;&nbsp;")}<br>`;if(addressesnotls.length>0)dyq+=`ADDNOTLS（noTLS优选域名&IP）:<br>&nbsp;&nbsp;${addressesnotls.join("<br>&nbsp;&nbsp;")}<br>`;if(addressesapi.length>0)dyq+=`ADDAPI（TLS优选域名&IP的API）:<br>&nbsp;&nbsp;${addressesapi.join("<br>&nbsp;&nbsp;")}<br>`;if(addressesnotlsapi.length>0)dyq+=`ADDNOTLSAPI（noTLS优选域名&IP的API）:<br>&nbsp;&nbsp;${addressesnotlsapi.join("<br>&nbsp;&nbsp;")}<br>`;if(addressescsv.length>0)dyq+=`ADDCSV（IPTest测速csv文件限速${DLS}）:<br>&nbsp;&nbsp;${addressescsv.join("<br>&nbsp;&nbsp;")}<br>`}if(tiaoid&&g.pathname!==`/${tiaoid}`)dyq="";else dyq+=`<br>SUBAPI（订阅转换后端）:${subProtocol}:const dtUID=uuid!==b?`TOKEN:${uuid}<br>UUIDNow:${b}<br>UUIDLow:${userIDLow}<br>${userIDTime}TIME（动态UUID有效时间）:${time01}天<br>UPTIME（动态UUID更新时间）:${time02}时（北京时间）<br><br>`:`${userIDTime}`;return`################################################################<br>Subscribe/d订阅地址,支持Base64、clash-meta、sing-box订阅格式<br>---------------------------------------------------------------<br>自适应订阅地址:<br><a href="javascript:void(0)"onclick="copyToClipboard('https://${proxyhost}${hostName}/${uuid}')"style="color:blue;text-decoration:underline;cursor:pointer;">https:<a href="javascript:void(0)"onclick="copyToClipboard('https://${proxyhost}${hostName}/${uuid}?sub')"style="color:blue;text-decoration:underline;cursor:pointer;">https:<br>Base64订阅地址:<br><a href="javascript:void(0)"onclick="copyToClipboard('https://${proxyhost}${hostName}/${uuid}?b64')"style="color:blue;text-decoration:underline;cursor:pointer;">https:<a href="javascript:void(0)"onclick="copyToClipboard('https://${proxyhost}${hostName}/${uuid}?base64')"style="color:blue;text-decoration:underline;cursor:pointer;">https:<br>clash订阅地址:<br><a href="javascript:void(0)"onclick="copyToClipboard('https://${proxyhost}${hostName}/${uuid}?clash')"style="color:blue;text-decoration:underline;cursor:pointer;">https:<br>singbox订阅地址:<br><a href="javascript:void(0)"onclick="copyToClipboard('https://${proxyhost}${hostName}/${uuid}?sb')"style="color:blue;text-decoration:underline;cursor:pointer;">https:<a href="javascript:void(0)"onclick="copyToClipboard('https://${proxyhost}${hostName}/${uuid}?singbox')"style="color:blue;text-decoration:underline;cursor:pointer;">https:<br><strong><a href="javascript:void(0);"id="noticeToggle"onclick="toggleNotice()">实用订阅技巧∨</a></strong><br><div id="noticeContent"class="notice-content"style="display: none;"><strong>1.</strong>如您使用的是PassWall、SSR+等路由插件，推荐使用<strong>Base64订阅地址</strong>进行订阅；<br><br><strong>2.</strong>快速切换<a href='${atob(
            "aHR0cHM6Ly9naXRodWIuY29tL2NtbGl1L1dvcmtlclZsZXNzMnN1Yg=="
        )}'>优选订阅生成器</a>至：d.google.com，您可将"?sub=sub.google.com"参数添加到链接末尾，例如：<br>&nbsp;&nbsp;https:<br><strong>3.</strong>快速更换PROXYIP至：proxyip.fxxk.dedyn.io:443，您可将"?proxyip=proxyip.fxxk.dedyn.io:443"参数添加到链接末尾，例如：<br>&nbsp;&nbsp;https:<br><strong>4.</strong>快速更换SOCKS5至：user:password@127.0.0.1:1080，您可将"?socks5=user:password@127.0.0.1:1080"参数添加到链接末尾，例如：<br>&nbsp;&nbsp;https:<br><strong>5.</strong>如需指定多个参数则需要使用'&'做间隔，例如：<br>&nbsp;&nbsp;https:</div><script>function copyToClipboard(a){navigator.clipboard.writeText(a).then(()=>{alert('已复制到剪贴板')}).catch(err=>{console.error('复制失败:',err)})}function toggleNotice(){const noticeContent=document.getElementById('noticeContent');const noticeToggle=document.getElementById('noticeToggle');if(noticeContent.style.display==='none'){noticeContent.style.display='block';noticeToggle.textContent='实用订阅技巧∧'}else{noticeContent.style.display='none';noticeToggle.textContent='实用订阅技巧∨'}}</script>---------------------------------------------------------------<br>################################################################<br>${FileName}配置信息<br>---------------------------------------------------------------<br>${dtUID}HOST:${c}<br>UUID:${b}<br>FKID:${fakeUserID}<br>e:${e}<br>${dyq}<br>---------------------------------------------------------------<br>################################################################<br>v2ray<br>---------------------------------------------------------------<br><a href="javascript:void(0)"onclick="copyToClipboard('${v2ray}')"style="color:blue;text-decoration:underline;cursor:pointer;">${v2ray}</a><br>---------------------------------------------------------------<br>################################################################<br>clash-meta<br>---------------------------------------------------------------<br>${clash}<br>---------------------------------------------------------------<br>################################################################<br>${cmad}`}else{if(typeof fetch!="function"){return"Error: fetch is not available in this environment."}let newAddressesapi=[];let newAddressescsv=[];let newAddressesnotlsapi=[];let newAddressesnotlscsv=[];if(c.includes(".workers.dev")){noTLS="true";fakeHostName=`${fakeHostName}.workers.dev`;newAddressesnotlsapi=await shoushigoodlist(addressesnotlsapi);newAddressesnotlscsv=await shoushics("FALSE")}else if(c.includes(".pages.dev")){fakeHostName=`${fakeHostName}.pages.dev`}else if(c.includes("worker")||c.includes("notls")||noTLS==="true"){noTLS="true";fakeHostName=`notls${fakeHostName}.net`;newAddressesnotlsapi=await shoushigoodlist(addressesnotlsapi);newAddressesnotlscsv=await shoushics("FALSE")}else{fakeHostName=`${fakeHostName}.xyz`}console.log(`虚假HOST:${fakeHostName}`);let url=`${subProtocol}:}&path=${encodeURIComponent(path)}`;let isBase64=true;if(!d||d===""){if(c.includes("workers.dev")){if(proxyhostsURL&&(!proxyhosts||proxyhosts.length===0)){try{const response=await fetch(proxyhostsURL);if(!response.ok){console.error("获取地址时出错:",response.status,response.statusText);return}const text=await response.text();const lines=text.split("\n");const nonEmptyLines=lines.filter((line)=>line.trim()!=="");proxyhosts=proxyhosts.concat(nonEmptyLines)}catch(error){console.error("获取地址时出错:",error)}}proxyhosts=[...new Set(proxyhosts)]}newAddressesapi=await shoushigoodlist(addressesapi);newAddressescsv=await shoushics("TRUE");url=`https:if(c.includes("worker")||c.includes("notls")||noTLS==="true"){if(g.search)url+="&notls";else url+="?notls"}console.log(`虚假订阅:${url}`)}if(!userAgent.includes("CF-Workers-SUB".toLowerCase())){if((userAgent.includes("clash")&&!userAgent.includes("nekobox"))||(g.searchParams.has("clash")&&!userAgent.includes("subconverter"))){url=`${subProtocol}:url)}&insert=false&config=${encodeURIComponent(subConfig)}&emoji=${subEmoji}&list=false&tfo=false&scv=true&fdn=false&sort=false&new_name=true`;isBase64=false}else if(userAgent.includes("sing-box")||userAgent.includes("singbox")||((g.searchParams.has("singbox")||g.searchParams.has("sb"))&&!userAgent.includes("subconverter"))){url=`${subProtocol}:url)}&insert=false&config=${encodeURIComponent(subConfig)}&emoji=${subEmoji}&list=false&tfo=false&scv=true&fdn=false&sort=false&new_name=true`;isBase64=false}}try{let content;if((!sub||sub==="")&&isBase64===true){content=celocaldy(fakeHostName,fakeUserID,noTLS,newAddressesapi,newAddressescsv,newAddressesnotlsapi,newAddressesnotlscsv)}else{const response=await fetch(url,{headers:{"User-Agent":UA+atob("IENGLVdvcmtlcnMtZWRnZXR1bm5lbC9jbWxpdQ=="),},});content=await response.text()}if(_url.pathname===`/${fakeUserID}`)return content;return hfwzxx(content,userID,hostName,isBase64)}catch(error){console.error("Error fetching content:",error);return`Error fetching content:${error.message}`}}}async function shoushigoodlist(a){if(!a||a.length===0)return[];let newapi="";const controller=new AbortController();const timeout=setTimeout(()=>{controller.abort()},2000);try{const responses=await Promise.allSettled(a.map((apiUrl)=>fetch(apiUrl,{method:"get",headers:{Accept:"text/html,application/xhtml+xml,application/xml;","User-Agent":atob("Q0YtV29ya2Vycy1lZGdldHVubmVsL2NtbGl1"),},signal:controller.signal,}).then((response)=>response.ok?response.text():Promise.reject())));for(const[index,response]of responses.entries()){if(response.status==="fulfilled"){const content=await response.value;const lines=content.split(/\r?\n/);let jdbz="";let csdk="443";if(lines[0].split(",").length>3){const idMatch=a[index].match(/id=([^&]*)/);if(idMatch)jdbz=idMatch[1];const portMatch=a[index].match(/port=([^&]*)/);if(portMatch)csdk=portMatch[1];for(let i=1;i<lines.length;i++){const columns=lines[i].split(",")[0];if(columns){newapi+=`${columns}:${csdk}${jdbz?`#${jdbz}`:""}\n`;if(a[index].includes("proxyip=true"))proxyIPPool.push(`${columns}:${csdk}`)}}}else{if(a[index].includes("proxyip=true")){proxyIPPool=proxyIPPool.concat((await shoushi(content)).map((item)=>{const baseItem=item.split("#")[0]||item;if(baseItem.includes(":")){const port=baseItem.split(":")[1];if(!httpsPorts.includes(port)){return baseItem}}else{return`${baseItem}:443`}return null}).filter(Boolean))}newapi+=content+"\n"}}}}catch(error){console.error(error)}finally{clearTimeout(timeout)}return await shoushi(newapi)}async function shoushics(a){if(!addressescsv||addressescsv.length===0){return[]}let newAddressescsv=[];for(const csvUrl of addressescsv){try{const response=await fetch(csvUrl);if(!response.ok){console.error("获取CSV地址时出错:",response.status,response.statusText);continue}const text=await response.text();let lines;if(text.includes("\r\n")){lines=text.split("\r\n")}else{lines=text.split("\n")}const header=lines[0].split(",");const tlsIndex=header.indexOf("TLS");const ipAddressIndex=0;const portIndex=1;const dataCenterIndex=tlsIndex+remarkIndex;if(tlsIndex===-1){console.error("CSV文件缺少必需的字段");continue}for(let i=1;i<lines.length;i++){const columns=lines[i].split(",");const speedIndex=columns.length-1;if(columns[tlsIndex].toUpperCase()===a&&parseFloat(columns[speedIndex])>DLS){const ipAddress=columns[ipAddressIndex];const port=columns[portIndex];const dataCenter=columns[dataCenterIndex];const formattedAddress=`${ipAddress}:${port}#${dataCenter}`;newAddressescsv.push(formattedAddress);if(csvUrl.includes("proxyip=true")&&columns[tlsIndex].toUpperCase()==="true"&&!httpsPorts.includes(port)){proxyIPPool.push(`${ipAddress}:${port}`)}}}}catch(error){console.error("获取CSV地址时出错:",error)}}return newAddressescsv}function celocaldy(a,b,c,d,e,f,g){const regex=/^(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}|\[.*]):?(\d+)?#?(.*)?$/;addresses=addresses.concat(d);addresses=addresses.concat(e);let notlsresponseBody;if(c==="true"){addressesnotls=addressesnotls.concat(f);addressesnotls=addressesnotls.concat(g);const uniqueAddressesnotls=[...new Set(addressesnotls)];notlsresponseBody=uniqueAddressesnotls.map((address)=>{let port="-1";let addressid=address;const match=addressid.match(regex);if(!match){if(address.includes(":")&&address.includes("#")){const parts=address.split(":");address=parts[0];const subParts=parts[1].split("#");port=subParts[0];addressid=subParts[1]}else if(address.includes(":")){const parts=address.split(":");address=parts[0];port=parts[1]}else if(address.includes("#")){const parts=address.split("#");address=parts[0];addressid=parts[1]}if(addressid.includes(":")){addressid=addressid.split(":")[0]}}else{address=match[1];port=match[2]||port;addressid=match[3]||address}const httpPorts=["8080","8880","2052","2082","2086","2095"];if(!isValidIPv4(address)&&port==="-1"){for(let httpPort of httpPorts){if(address.includes(httpPort)){port=httpPort;break}}}if(port==="-1")port="80";let wzym=a;let zzul=path;let jdbz="";const xylx=atob(what);return`${xylx}:atob("P2VuY3J5cHRpb249bm9uZSZzZWN1cml0eT0mdHlwZT13cyZob3N0PQ==")+wzym}&path=${encodeURIComponent(zzul)}#${encodeURIComponent(addressid+jdbz)}`}).join("\n")}const uniqueAddresses=[...new Set(addresses)];let base64Response=uniqueAddresses.map((address)=>{let port="-1";let addressid=address;const match=addressid.match(regex);if(!match){if(address.includes(":")&&address.includes("#")){const parts=address.split(":");address=parts[0];const subParts=parts[1].split("#");port=subParts[0];addressid=subParts[1]}else if(address.includes(":")){const parts=address.split(":");address=parts[0];port=parts[1]}else if(address.includes("#")){const parts=address.split("#");address=parts[0];addressid=parts[1]}if(addressid.includes(":")){addressid=addressid.split(":")[0]}}else{address=match[1];port=match[2]||port;addressid=match[3]||address}if(!isValidIPv4(address)&&port==="-1"){for(let httpsPort of httpsPorts){if(address.includes(httpsPort)){port=httpsPort;break}}}if(port==="-1")port="443";let wzym=host;let zzul=path;let jdbz="";const matchingProxyIP=proxyIPPool.find((proxyIP)=>proxyIP.includes(address));if(matchingProxyIP)zzul+=`&proxyip=${matchingProxyIP}`;if(proxyhosts.length>0&&wzym.includes(".workers.dev")){zzul=`/${wzym}${zzul}`;wzym=proxyhosts[Math.floor(Math.random()*proxyhosts.length)];jdbz=`已启用临时域名中转服务，请尽快绑定自定义域！`}const xylx=atob(what);return`${xylx}:}&fp=random&type=ws&host=${wzym}&path=${encodeURIComponent(zzul)}#${encodeURIComponent(addressid+jdbz)}`}).join("\n");if(noTLS==="true")base64Response+=`\n${notlsresponseBody}`;if(link.length>0)base64Response+="\n"+link.join("\n");return btoa(base64Response)}async function shoushi(a){let recontent=a.replace(/[	|"'\r\n]+/g,",").replace(/,+/g,",");if(recontent.charAt(0)===",")recontent=recontent.slice(1);if(recontent.charAt(recontent.length-1)===",")recontent=recontent.slice(0,recontent.length-1);return recontent.split(",")}async function sendMessage(a,b,c){if(!BotToken||!ChatID)return;try{let msg;const response=await fetch(`https:if(response.ok){const ipInfo=await response.json();msg=`${a}\nIP:${b}\n国家:${ipInfo.country}\n<tg-spoiler>城市:${ipInfo.city}\n组织:${ipInfo.org}\nASN:${ipInfo.as}\n${add_data}`}else{msg=`${a}\nIP:${b}\n<tg-spoiler>${add_data}`}const url=`https:msg)}`;return fetch(url,{method:"GET",headers:{Accept:"text/html,application/xhtml+xml,application/xml;","Accept-Encoding":"gzip, deflate, br","User-Agent":"Mozilla/5.0 Chrome/90.0.4430.72",},})}catch(error){console.error("Error sending message:",error)}}function isValidIPv4(a){const ipv4Regex=/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;return ipv4Regex.test(a)}function cetiaoid(c){const sqpy=8;const srq=new Date(2007,6,7,time02,0,0);const yzhm=1000*60*60*24*time01;function getnowz(){const dnow=new Date();const tznow=new Date(dnow.getTime()+sqpy*60*60*1000);const timec=Number(tznow)-Number(srq);return Math.ceil(timec/yzhm)}function ceID(a){const shahc=new TextEncoder().encode(a);return crypto.subtle.digest("SHA-256",shahc).then((sha)=>{const shaarr=Array.from(new Uint8Array(sha));const slsha=shaarr.map((b)=>b.toString(16).padStart(2,"0")).join("");return`${slsha.slice(0,8)}-${slsha.slice(8,12)}-4${slsha.slice(12,15)}-${((parseInt(slsha.slice(15,17),16)&0x3f)|0x80).toString(16)}${slsha.slice(17,19)}-${slsha.slice(19,31)}`})}const nowz=getnowz();const etime=new Date(srq.getTime()+nowz*yzhm);const dnowUIDP=ceID(c+nowz);const prUIDP=ceID(c+(nowz-1));const endtimeUTC=new Date(etime.getTime()-sqpy*60*60*1000);const endtimestr=`到期时间(UTC):${endtimeUTC.toISOString().slice(0,19).replace("T"," ")}(UTC+8):${etime.toISOString().slice(0,19).replace("T"," ")}\n`;return Promise.all([dnowUIDP,prUIDP,endtimestr])}async function qydzlist(a,b){const osj=await a.KV.get(`/${txt}`);const nsj=await a.KV.get(txt);if(osj&&!nsj){await a.KV.put(txt,osj);await a.KV.delete(`/${txt}`);return true}return false}async function KV(b,c,d){try{if(b.method==="POST"){if(!c.KV)return new Response("未绑定KV空间",{status:400});try{const content=await b.text();await c.KV.put(txt,content);return new Response("保存成功")}catch(error){console.error("保存KV时发生错误:",error);return new Response("保存失败: "+error.message,{status:500})}}let content="";let hasKV=!!c.KV;if(hasKV){try{content=(await c.KV.get(txt))||""}catch(error){console.error("读取KV时发生错误:",error);content="读取数据时发生错误: "+error.message}}const html=`<!DOCTYPE html><html lang=""><head><title>优选订阅列表</title><meta charset="utf-8"><meta name="viewport"content="width=device-width, initial-scale=1"><style>body{margin:0;padding:15px;box-sizing:border-box;font-size:13px}.editor-container{width:100%;max-width:100%;margin:0 auto}.editor{width:100%;height:520px;margin:15px 0;padding:10px;box-sizing:border-box;border:1px solid#ccc;border-radius:4px;font-size:13px;line-height:1.5;overflow-y:auto;resize:none}.save-container{margin-top:8px;display:flex;align-items:center;gap:10px}.save-btn,.back-btn{padding:6px 15px;color:white;border:none;border-radius:4px;cursor:pointer}.save-btn{background:"SUBAPI.fxxk.dedyn.io"CAF50}.save-btn:hover{background:"sub"a049}.back-btn{background:undefined}.back-btn:hover{background:undefined}.save-status{color:undefined}.notice-content{display:none;margin-top:10px;font-size:13px;color:"sing-box"}</style></head><body>################################################################<br>${FileName}优选订阅列表:<br>---------------------------------------------------------------<br>&nbsp;&nbsp;<strong><a href="javascript:void(0);"id="noticeToggle"onclick="toggleNotice()">注意事项∨</a></strong><br><div id="noticeContent"class="notice-content">${decodeURIComponent(atob("JTA5JTA5JTA5JTA5JTA5JTNDc3Ryb25nJTNFMS4lM0MlMkZzdHJvbmclM0UlMjBBRERBUEklMjAlRTUlQTYlODIlRTYlOUUlOUMlRTYlOTglQUYlRTUlOEYlOEQlRTQlQkIlQTNJUCVFRiVCQyU4QyVFNSU4RiVBRiVFNCVCRCU5QyVFNCVCOCVCQVBST1hZSVAlRTclOUElODQlRTglQUYlOUQlRUYlQkMlOEMlRTUlOEYlQUYlRTUlQjAlODYlMjIlM0Zwcm94eWlwJTNEdHJ1ZSUyMiVFNSU4RiU4MiVFNiU5NSVCMCVFNiVCNyVCQiVFNSU4QSVBMCVFNSU4OCVCMCVFOSU5MyVCRSVFNiU4RSVBNSVFNiU5QyVBQiVFNSVCMCVCRSVFRiVCQyU4QyVFNCVCRSU4QiVFNSVBNiU4MiVFRiVCQyU5QSUzQ2JyJTNFCiUwOSUwOSUwOSUwOSUwOSUyNm5ic3AlM0IlMjZuYnNwJTNCaHR0cHMlM0ElMkYlMkZyYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tJTJGY21saXUlMkZXb3JrZXJWbGVzczJzdWIlMkZtYWluJTJGYWRkcmVzc2VzYXBpLnR4dCUzQ3N0cm9uZyUzRSUzRnByb3h5aXAlM0R0cnVlJTNDJTJGc3Ryb25nJTNFJTNDYnIlM0UlM0NiciUzRQolMDklMDklMDklMDklMDklM0NzdHJvbmclM0UyLiUzQyUyRnN0cm9uZyUzRSUyMEFEREFQSSUyMCVFNSVBNiU4MiVFNiU5RSU5QyVFNiU5OCVBRiUyMCUzQ2ElMjBocmVmJTNEJTI3aHR0cHMlM0ElMkYlMkZnaXRodWIuY29tJTJGWElVMiUyRkNsb3VkZmxhcmVTcGVlZFRlc3QlMjclM0VDbG91ZGZsYXJlU3BlZWRUZXN0JTNDJTJGYSUzRSUyMCVFNyU5QSU4NCUyMGNzdiUyMCVFNyVCQiU5MyVFNiU5RSU5QyVFNiU5NiU4NyVFNCVCQiVCNiVFRiVCQyU4QyVFNCVCRSU4QiVFNSVBNiU4MiVFRiVCQyU5QSUzQ2JyJTNFCiUwOSUwOSUwOSUwOSUwOSUyNm5ic3AlM0IlMjZuYnNwJTNCaHR0cHMlM0ElMkYlMkZyYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tJTJGY21saXUlMkZXb3JrZXJWbGVzczJzdWIlMkZyZWZzJTJGaGVhZHMlMkZtYWluJTJGQ2xvdWRmbGFyZVNwZWVkVGVzdC5jc3YlM0NiciUzRSUzQ2JyJTNFCiUwOSUwOSUwOSUwOSUwOSUyNm5ic3AlM0IlMjZuYnNwJTNCLSUyMCVFNSVBNiU4MiVFOSU5QyU4MCVFNiU4QyU4NyVFNSVBRSU5QTIwNTMlRTclQUIlQUYlRTUlOEYlQTMlRTUlOEYlQUYlRTUlQjAlODYlMjIlM0Zwb3J0JTNEMjA1MyUyMiVFNSU4RiU4MiVFNiU5NSVCMCVFNiVCNyVCQiVFNSU4QSVBMCVFNSU4OCVCMCVFOSU5MyVCRSVFNiU4RSVBNSVFNiU5QyVBQiVFNSVCMCVCRSVFRiVCQyU4QyVFNCVCRSU4QiVFNSVBNiU4MiVFRiVCQyU5QSUzQ2JyJTNFCiUwOSUwOSUwOSUwOSUwOSUyNm5ic3AlM0IlMjZuYnNwJTNCaHR0cHMlM0ElMkYlMkZyYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tJTJGY21saXUlMkZXb3JrZXJWbGVzczJzdWIlMkZyZWZzJTJGaGVhZHMlMkZtYWluJTJGQ2xvdWRmbGFyZVNwZWVkVGVzdC5jc3YlM0NzdHJvbmclM0UlM0Zwb3J0JTNEMjA1MyUzQyUyRnN0cm9uZyUzRSUzQ2JyJTNFJTNDYnIlM0UKJTA5JTA5JTA5JTA5JTA5JTI2bmJzcCUzQiUyNm5ic3AlM0ItJTIwJUU1JUE2JTgyJUU5JTlDJTgwJUU2JThDJTg3JUU1JUFFJTlBJUU4JThBJTgyJUU3JTgyJUI5JUU1JUE0JTg3JUU2JUIzJUE4JUU1JThGJUFGJUU1JUIwJTg2JTIyJTNGaWQlM0RDRiVFNCVCQyU5OCVFOSU4MCU4OSUyMiVFNSU4RiU4MiVFNiU5NSVCMCVFNiVCNyVCQiVFNSU4QSVBMCVFNSU4OCVCMCVFOSU5MyVCRSVFNiU4RSVBNSVFNiU5QyVBQiVFNSVCMCVCRSVFRiVCQyU4QyVFNCVCRSU4QiVFNSVBNiU4MiVFRiVCQyU5QSUzQ2JyJTNFCiUwOSUwOSUwOSUwOSUwOSUyNm5ic3AlM0IlMjZuYnNwJTNCaHR0cHMlM0ElMkYlMkZyYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tJTJGY21saXUlMkZXb3JrZXJWbGVzczJzdWIlMkZyZWZzJTJGaGVhZHMlMkZtYWluJTJGQ2xvdWRmbGFyZVNwZWVkVGVzdC5jc3YlM0NzdHJvbmclM0UlM0ZpZCUzRENGJUU0JUJDJTk4JUU5JTgwJTg5JTNDJTJGc3Ryb25nJTNFJTNDYnIlM0UlM0NiciUzRQolMDklMDklMDklMDklMDklMjZuYnNwJTNCJTI2bmJzcCUzQi0lMjAlRTUlQTYlODIlRTklOUMlODAlRTYlOEMlODclRTUlQUUlOUElRTUlQTQlOUElRTQlQjglQUElRTUlOEYlODIlRTYlOTUlQjAlRTUlODglOTklRTklOUMlODAlRTglQTYlODElRTQlQkQlQkYlRTclOTQlQTglMjclMjYlMjclRTUlODElOUElRTklOTclQjQlRTklOUElOTQlRUYlQkMlOEMlRTQlQkUlOEIlRTUlQTYlODIlRUYlQkMlOUElM0NiciUzRQolMDklMDklMDklMDklMDklMjZuYnNwJTNCJTI2bmJzcCUzQmh0dHBzJTNBJTJGJTJGcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSUyRmNtbGl1JTJGV29ya2VyVmxlc3Myc3ViJTJGcmVmcyUyRmhlYWRzJTJGbWFpbiUyRkNsb3VkZmxhcmVTcGVlZFRlc3QuY3N2JTNGaWQlM0RDRiVFNCVCQyU5OCVFOSU4MCU4OSUzQ3N0cm9uZyUzRSUyNiUzQyUyRnN0cm9uZyUzRXBvcnQlM0QyMDUzJTNDYnIlM0U="))}</div><div class="editor-container">${hasKV?`<textarea class="editor"placeholder="${decodeURIComponent(
    atob(
    "QUREJUU3JUE0JUJBJUU0JUJFJThCJUVGJUJDJTlBCnZpc2EuY24lMjMlRTQlQkMlOTglRTklODAlODklRTUlOUYlOUYlRTUlOTAlOEQKMTI3LjAuMC4xJTNBMTIzNCUyM0NGbmF0CiU1QjI2MDYlM0E0NzAwJTNBJTNBJTVEJTNBMjA1MyUyM0lQdjYKCiVFNiVCMyVBOCVFNiU4NCU4RiVFRiVCQyU5QQolRTYlQUYlOEYlRTglQTElOEMlRTQlQjglODAlRTQlQjglQUElRTUlOUMlQjAlRTUlOUQlODAlRUYlQkMlOEMlRTYlQTAlQkMlRTUlQkMlOEYlRTQlQjglQkElMjAlRTUlOUMlQjAlRTUlOUQlODAlM0ElRTclQUIlQUYlRTUlOEYlQTMlMjMlRTUlQTQlODclRTYlQjMlQTgKSVB2NiVFNSU5QyVCMCVFNSU5RCU4MCVFOSU5QyU4MCVFOCVBNiU4MSVFNyU5NCVBOCVFNCVCOCVBRCVFNiU4QiVBQyVFNSU4RiVCNyVFNiU4QiVBQyVFOCVCNSVCNyVFNiU5RCVBNSVFRiVCQyU4QyVFNSVBNiU4MiVFRiVCQyU5QSU1QjI2MDYlM0E0NzAwJTNBJTNBJTVEJTNBMjA1MwolRTclQUIlQUYlRTUlOEYlQTMlRTQlQjglOEQlRTUlODYlOTklRUYlQkMlOEMlRTklQkIlOTglRTglQUUlQTQlRTQlQjglQkElMjA0NDMlMjAlRTclQUIlQUYlRTUlOEYlQTMlRUYlQkMlOEMlRTUlQTYlODIlRUYlQkMlOUF2aXNhLmNuJTIzJUU0JUJDJTk4JUU5JTgwJTg5JUU1JTlGJTlGJUU1JTkwJThECgoKQUREQVBJJUU3JUE0JUJBJUU0JUJFJThCJUVGJUJDJTlBCmh0dHBzJTNBJTJGJTJGcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSUyRmNtbGl1JTJGV29ya2VyVmxlc3Myc3ViJTJGcmVmcyUyRmhlYWRzJTJGbWFpbiUyRmFkZHJlc3Nlc2FwaS50eHQKCiVFNiVCMyVBOCVFNiU4NCU4RiVFRiVCQyU5QUFEREFQSSVFNyU5QiVCNCVFNiU4RSVBNSVFNiVCNyVCQiVFNSU4QSVBMCVFNyU5QiVCNCVFOSU5MyVCRSVFNSU4RCVCMyVFNSU4RiVBRg=="
    )
    )}"id="content">${content}</textarea><div class="save-container"><button class="back-btn"onclick="goBack()">返回配置页</button><button class="save-btn"onclick="saveContent(this)">保存</button><span class="save-status"id="saveStatus"></span></div><br>################################################################<br>${cmad}`:"<p>未绑定KV空间</p>"}</div><script>if(document.querySelector('.editor')){let timer;const textarea=document.getElementById('content');const originalContent=textarea.value;function goBack(){const currentUrl=window.location.href;window.location.href=currentUrl.substring(0,currentUrl.lastIndexOf('/'))}function replaceFullwidthColon(){const text=textarea.value;textarea.value=text.replace(/：/g,':')}function saveContent(a){try{const updateButtonText=(step)=>{a.textContent=\`保存中:\${step}\`};const isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent);if(!isIOS){replaceFullwidthColon()}updateButtonText('开始保存');a.disabled=true;const textarea=document.getElementById('content');if(!textarea){throw new Error('找不到文本编辑区域');}updateButtonText('获取内容');let newContent;let originalContent;try{newContent=textarea.value||'';originalContent=textarea.defaultValue||''}catch(e){console.error('获取内容错误:',e);throw new Error('无法获取编辑内容');}updateButtonText('准备状态更新函数');const updateStatus=(message,isError=false)=>{const statusElem=document.getElementById('saveStatus');if(statusElem){statusElem.textContent=message;statusElem.style.color=isError?'red':'#666'}};updateButtonText('准备按钮重置函数');const resetButton=()=>{a.textContent='保存';a.disabled=false};if(newContent!==originalContent){updateButtonText('发送保存请求');fetch(window.location.href,{method:'POST',body:newContent,headers:{'Content-Type':'text/plain;charset=UTF-8'},cache:'no-cache'}).then(response=>{updateButtonText('检查响应状态');if(!response.ok){throw new Error(\`HTTP error!status:\${response.status}\`)}updateButtonText('更新保存状态');const now=new Date().toLocaleString();document.title=\`编辑已保存\${now}\`;updateStatus(\`已保存\${now}\`)}).catch(error=>{updateButtonText('处理错误');console.error('Save error:',error);updateStatus(\`保存失败:\${error.message}\`,true)}).finally(()=>{resetButton()})}else{updateButtonText('检查内容变化');updateStatus('内容未变化');resetButton()}}catch(error){console.error('保存过程出错:',error);a.textContent='保存';a.disabled=false;const statusElem=document.getElementById('saveStatus');if(statusElem){statusElem.textContent=\`错误:\${error.message}\`;statusElem.style.color='red'}}}textarea.addEventListener('blur',saveContent);textarea.addEventListener('input',()=>{clearTimeout(timer);timer=setTimeout(saveContent,5000)})}function toggleNotice(){const noticeContent=document.getElementById('noticeContent');const noticeToggle=document.getElementById('noticeToggle');if(noticeContent.style.display==='none'||noticeContent.style.display===''){noticeContent.style.display='block';noticeToggle.textContent='注意事项∧'}else{noticeContent.style.display='none';noticeToggle.textContent='注意事项∨'}}document.addEventListener('DOMContentLoaded',()=>{document.getElementById('noticeContent').style.display='none'});</script></body></html>`;return new Response(html,{headers:{"Content-Type":"text/html;charset=utf-8"},})}catch(error){console.error("处理请求时发生错误:",error);return new Response("服务器错误: "+error.message,{status:500,headers:{"Content-Type":"text/plain;charset=utf-8"},})}}